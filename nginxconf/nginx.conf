events {
  worker_connections 128;
}

http {
  # cache for validation results
  limit_conn_zone $server_name zone=servers:10m;

  log_format  main  '$remote_addr - [$time_local] "$request" '
                  '$status $body_bytes_sent $upstream_connect_time $upstream_header_time '
                  '$upstream_response_time $upstream_response_time "$http_referer" '
                  '"$http_user_agent" "$http_x_forwarded_for"';

  access_log  /var/log/nginx/access.log  main;

  server {
    listen 80 default_server;
    server_name _;
    return 301 https://$host$request_uri;
  }

  server {
    listen 443 ssl;
    server_name testmedirad.kheops.online;

    ssl_certificate /run/secrets/irdbb-fullchain.pem;
    ssl_certificate_key /run/secrets/irdbb-privkey.pem;
    ssl_trusted_certificate /etc/nginx/irdbb-cert.pem;

    return 301 https://irdbb.kheops.online$request_uri;
  }

  server {
    listen 443 ssl;
    server_name irdbb-staging.kheops.online;

    ssl_certificate /run/secrets/irdbb-fullchain.pem;
    ssl_certificate_key /run/secrets/irdbb-privkey.pem;
    ssl_trusted_certificate /etc/nginx/irdbb-cert.pem;

    error_log  stderr  info;
    rewrite_log on;

    client_max_body_size 20000M;
    proxy_send_timeout      120;
    proxy_read_timeout      120;
    proxy_request_buffering off;
    proxy_buffering         off;
    proxy_http_version      1.1;
    proxy_max_temp_file_size 0;

    location / {
      allow   85.195.240.17;    # Joël Spaltenstein
      allow   31.10.165.65;     # Nicolas van Dooren
      allow   178.192.85.129;   # Gérôme Pasquier
      allow   51.154.159.85;    # Salvatore Cicciu
      allow   109.220.170.39;   # Alex Vergara Gil
      allow   78.230.250.7;     # Bernard Gibaud
      allow   91.167.251.222;   # Guillame Pasquier

      allow   134.93.0.0/16;    # Université de Mainz
      allow   194.25.0.0/16;    # Université deMarburg
      allow   132.187.0.0/16;   # Université de Würzburg
      allow   194.167.0.0/16;   # IUCT Oncopole
      allow   154.43.32.0/24;   # B-COM
      allow   194.57.0.0/16;    # INSERM
      allow   84.88.0.0/16;     # ISGLOBAL
      allow   193.60.0.0/14;    # NHS foundation Trust
      allow   147.52.0.0/16;    # University of Crete

      deny    all;

      proxy_pass http://irdbbreverseproxy:80;
      proxy_redirect http://irdbbreverseproxy:80 https://irdbb-staging.kheops.online;
    }
  }

  server {
    listen 443 ssl http2;
    server_name medirad-staging.kheops.online;

    limit_conn servers 1000;

    ssl_certificate /run/secrets/kheops-fullchain.pem;
    ssl_certificate_key /run/secrets/kheops-privkey.pem;
    ssl_trusted_certificate /etc/nginx/irdbb-cert.pem;

    ssl_session_timeout 1d;
    ssl_session_cache shared:SSL:50m;
    ssl_session_tickets off;

    ssl_protocols TLSv1.2 TLSv1.3;
    ssl_ciphers TLS13-AES-256-GCM-SHA384:TLS13-AES-128-GCM-SHA256:TLS13-AES-128-CCM-8-SHA256:TLS13-AES-128-CCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES128-CCM:ECDHE-ECDSA-AES256-CCM:ECDHE-ECDSA-AES128-CCM8:ECDHE-ECDSA-AES256-CCM8:ECDHE-ECDSA-AES128-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA38:DHE-RSA-AES128-GCM-SHA256:DHE-RSA-AES256-GCM-SHA384:DHE-RSA-AES128-CCM:DHE-RSA-AES256-CCM:DHE-RSA-AES128-CCM8:DHE-RSA-AES256-CCM8:ECDHE-RSA-AES128-SHA256:ECDHE-RSA-AES256-SHA384:DHE-RSA-AES128-SHA256:DHE-RSA-AES256-SHA256;
    ssl_prefer_server_ciphers on;

    ssl_stapling on;
    ssl_stapling_verify on;

    resolver 127.0.0.11 ipv6=off;

    server_tokens off;

    proxy_http_version 1.1;
    proxy_set_header Upgrade $http_upgrade;
    proxy_set_header Connection "upgrade";

    access_log            /var/log/nginx/access.log main;
    error_log             /var/log/nginx/error.log warn;

    client_max_body_size    20000M;
    proxy_send_timeout      120;
    proxy_read_timeout      120;
    proxy_request_buffering off;
    proxy_buffering         off;

    location / {
      allow   85.195.240.17;    # Joël Spaltenstein
      allow   31.10.165.65;     # Nicolas van Dooren
      allow   178.192.85.129;   # Gérôme Pasquier
      allow   51.154.159.85;    # Salvatore Cicciu
      allow   109.220.170.39;   # Alex Vergara Gil
      allow   78.230.250.7;     # Bernard Gibaud
      allow   91.167.251.222;   # Guillame Pasquier

      allow   134.93.0.0/16;    # Université de Mainz
      allow   194.25.0.0/16;    # Université de Marburg
      allow   132.187.0.0/16;   # Université de Würzburg
      allow   194.167.0.0/16;   # IUCT Oncopole
      allow   154.43.32.0/24;   # B-COM
      allow   194.57.0.0/16;    # INSERM
      allow   84.88.0.0/16;     # ISGLOBAL
      allow   193.60.0.0/14;    # NHS foundation Trust
      allow   147.52.0.0/16;    # University of Crete

      deny    all;

      proxy_pass http://kheopsreverseproxy:8042;
      proxy_redirect http://kheopsreverseproxy:8042 https://medirad-staging.kheops.online;
    }
  }
}
